<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="./img/favicon.ico">

	<title>Trigger Camera</title>

        <link href="./css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="./css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="./css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="./css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body class="homepage">

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href=".">Trigger Camera</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li class="active">
                        <a href=".">Home</a>
                    </li>
                
                
                
                    <li >
                        <a href="dev/">Dev</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li class="disabled">
                        <a rel="next" >
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="dev/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#trigger-camera">Trigger Camera</a></li>
        
    
        <li class="main "><a href="#overview">Overview</a></li>
        
            <li><a href="#background-on-the-raspberry-pi">Background on the Raspberry Pi</a></li>
        
            <li><a href="#software-implementation">Software implementation</a></li>
        
    
        <li class="main "><a href="#parts-list">Parts list</a></li>
        
    
        <li class="main "><a href="#configuring-a-raspberry-pi">Configuring a Raspberry Pi</a></li>
        
    
        <li class="main "><a href="#building-the-system">Building the system</a></li>
        
            <li><a href="#wiring-the-system">Wiring the system</a></li>
        
            <li><a href="#installing-required-python-libraries">Installing required Python libraries</a></li>
        
    
        <li class="main "><a href="#limitations">Limitations</a></li>
        
    
        <li class="main "><a href="#running-the-camera">Running the camera</a></li>
        
            <li><a href="#python-command-line-interface">Python command line interface</a></li>
        
            <li><a href="#web-interface_1">Web interface</a></li>
        
            <li><a href="#lcd-and-keypad-interface">LCD and keypad interface</a></li>
        
    
        <li class="main "><a href="#user-configuration">User configuration</a></li>
        
    
        <li class="main "><a href="#output-video">Output video</a></li>
        
    
        <li class="main "><a href="#output-files">Output files</a></li>
        
    
        <li class="main "><a href="#analysis">Analysis</a></li>
        
    
        <li class="main "><a href="#troubleshooting">Troubleshooting</a></li>
        
            <li><a href="#to-do">To Do</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="trigger-camera">Trigger Camera</h1>
<p>This is a Raspberry Pi camera that responds to digital TTL pulses to start and stop video acquisition during an experiment. During video acquisition, external events such as frame times on a scanning microscope are watermarked on the video and saved to a text file.</p>
<p>The camera can be controlled from a Python command prompt, via a web browser, or using a hardware LCD/keypad.</p>
<h1 id="overview">Overview</h1>
<h2 id="background-on-the-raspberry-pi">Background on the Raspberry Pi</h2>
<p>The Raspberry Pi is a low cost ($35) computer that runs Linux. In addition to USB, ethernet, and HDMI connectors, the Raspberry Pi has a dedicated camera port and low level digital input and output (DIO). Both the camera and DIO pins can be easily programmed  using Python.</p>
<p>The Raspberry Pi provides an end-to-end open source system. Both the hardware and the software is provided by <a href="https://www.raspberrypi.org">The Raspberry Pi Foundation</a> and an active developer community. Given that all components are open-source, there are some very unique upgrades that one does not see in a commercial marketplace. The Raspberry Pi computer itself has undergone three rounds of system upgrades, increasing its processor speed by more than a factor of ten, expanding its onboard RAM, and adding onboard WIFI and Bluetooth while the price has remained fixed at $35. When it was first released, the 5MP Raspberry Pi camera could record 640x480 video at 30 frames-per-second. With a software upgrade this capability was extended to 60 and 90 frames per second and a second camera was then released increasing the sensor size from 5MP to 8MP while keeping the price fixed at $25.</p>
<h2 id="software-implementation">Software implementation</h2>
<p>The software provided here will run a Raspberry Pi camera as a slave to other devices already in place for an experiment.</p>
<p>Once the camera is armed, it will continuously record a circular stream of video in memory. When a digital trigger is received, the the video will begin being saved to disk. In addition to saving the video after a trigger, the video before the trigger will also be saved. This has the distinct advantage of given you a record of what your animal was doing  before a trial was started. In many cases, 'bad trials' can be found because there was a lot of movement (or some other abberent event) before a trial began.</p>
<h1 id="parts-list">Parts list</h1>
<p>These parts are widely available at many different online sellers including: Sparkfun, Adafruit, Element14, and Amazon.</p>
<ul>
<li>Raspberry Pi 2 or 3</li>
<li>SD card</li>
<li>Power supply</li>
<li>USB stick to save video</li>
<li>Voltage level shifter</li>
<li>Raspberry Pi NoIR camera</li>
<li>Pi camera ribbon cables (2 meters)</li>
<li>IR LEDS</li>
<li>Cables to wire the Raspberry Pi to digital lines</li>
<li>Pi Camera ribbon cable to HDMI converter</li>
<li>[optional] 5V relay to allow Pi to switch higher voltage power (5V or 12V) on/off</li>
</ul>
<p>While the cost of the Pi is cheap, the price adds up with all the additional pieces needed. In the end, the total cost should be $100 to $150.</p>
<p>The Raspberry Pi can only accept digital signals at 3.5V. Many devices use 5V for digital signals. Thus, a level shifter is needed to convert 5V to 3.5V. This can be easily wired by hand as a voltage divider or purchased as a premade circuit board.</p>
<h1 id="configuring-a-raspberry-pi">Configuring a Raspberry Pi</h1>
<p>We are not going to provide a full tutorial here and assume you have a functioning Raspberry Pi. Here is a basic to do list to get started.</p>
<ul>
<li>Install Raspbian on an SD card and boot the pi</li>
<li>Configure wired network</li>
<li>Make sure the camera is installed</li>
<li>Install required python libraries</li>
<li>SMB to mount/share folders with Windows computers</li>
<li>AFP to mount/share folders with OS X (SMB will also work with OS X)</li>
<li>StartUpMailer to have the Raspberry Pi email with its IP address when it boots</li>
</ul>
<h1 id="building-the-system">Building the system</h1>
<h2 id="wiring-the-system">Wiring the system</h2>
<ul>
<li>Connect Camera to Raspberry Pi</li>
<li>Connect digital lines to the Raspberry Pi (be sure to convert 5V lines to 3.5V)</li>
<li>Ground the Raspberry Pi to the digital line ground/shield</li>
<li>Connect LEDs to the Raspberry Pi. If LEDs need a lot of power, hook them up with a 5V relay.</li>
</ul>
<h2 id="installing-required-python-libraries">Installing required Python libraries</h2>
<h3 id="python-interface">Python interface</h3>
<pre><code>RPi.GPIO
picamera
ConfigParser
</code></pre>
<h3 id="web-interface">Web Interface</h3>
<pre><code>flask
flask-socketio
</code></pre>
<h1 id="limitations">Limitations</h1>
<p>The Raspberry Pi runs Linux and like other operating systems including Microsoft Windows and Mac OS it is not real time. There will always be unpredictable delays in the detection and generation of digital pulses. If the detection of a fast pulse or the timing of a pulse is critical for an experiment it is strongly suggested to use a more precise microcontroller like an Arduino.</p>
<p>See the <strong>Analysis</strong> section for example Python code to test the limits of this precision.</p>
<h1 id="running-the-camera">Running the camera</h1>
<h2 id="python-command-line-interface">Python command line interface</h2>
<p>With <a href="https://github.com/cudmore/triggercamera/blob/master/triggercamera.py">triggercamera.py</a>, the camera can be controlled with a python command line interface. Once the camera is armed with 'ArmTrigger()' it will start and stop video recording following a TTL trigger.</p>
<pre><code>import triggercamera
tc=triggercamera.TriggerCamera()
tc.ArmTrigger()
</code></pre>
<p>Additional interface</p>
<pre><code>#start and stop video recording as much as you like
tc.startVideo()
tc.stopVideo()

# single images can be saved every few seconds while video is being recorded
tc.doTimelapse=1
tc.doTimelapse=0

# todo: add interface to control two different LEDs
</code></pre>
<h2 id="web-interface_1">Web interface</h2>
<p><a href="https://github.com/cudmore/triggercamera/blob/master/triggercamera_app.py">triggercamera_app.py</a> provides a web server allowing the camera to be controlled through a web browser. The web server is run using <a href="http://flask.pocoo.org">Flask</a> and provides a REST api as a wrapper around the triggercamera.py command line engine.</p>
<p>Run a web server with</p>
<pre><code>python triggercamera_app.py
</code></pre>
<p>The server will be available on the local IP address of the machine running the code, in this case '192.168.1.12'. The server will run on port 5010.</p>
<p>The camera can be controlled through a web browser as follows.</p>
<pre><code>http://192.168.1.12:5010/startarm
http://192.168.1.12:5010/stoparm
http://192.168.1.12:5010/startvideo
http://192.168.1.12:5010/stopvideo
http://192.168.1.12:5010/timelapseon
http://192.168.1.12:5010/timelapseoff
http://192.168.1.12:5010/lastimage
</code></pre>
<p><strong>to do:</strong> Add an actual web page with buttons to control the camera and give realtime feedback.</p>
<h2 id="lcd-and-keypad-interface">LCD and keypad interface</h2>
<p><strong>NOT IMPLEMENTED.</strong> A hardware interface is provided if an <a href="https://learn.adafruit.com/adafruit-16x2-character-lcd-plus-keypad-for-raspberry-pi">LCD/keypad</a> is attached to the Raspberry Pi.</p>
<h1 id="user-configuration">User configuration</h1>
<p>Modify <a href="https://github.com/cudmore/triggercamera/blob/master/config.ini">config.ini</a> and restart the camera code</p>
<pre><code>[triggers]
triggerpin: 4
framepin: 17

[led]
led1pin: 2
led2pin: 3

[camera]
fps: 30
resolution: 640,480
bufferSeconds = 5

watchedpathon: 1
watchedpath: /video

savepath: /video
</code></pre>
<h1 id="output-video">Output video</h1>
<p>Trigger camera saves video in the <a href="https://en.wikipedia.org/wiki/H.264/MPEG-4_AVC">h264</a> video format. This is a very efficient video codec that make very small but highly detailed videos. Before you analyze these h264 video files they need to be converted to include the frames per second. This can be done in a number of video editing programs but we suggest <a href="https://ffmpeg.org">ffmpeg</a> because it can be scripted and incorporated into most workflows.</p>
<p><strong>to do</strong> Supply real ffmpeg code</p>
<pre><code>srcDir = '/src/dir/with/video'
dstDir = 'dst/dir/for/mp4'
for file in srcDir:
    outfile = file.strip('h264') + '.mp4'
    ffmpeg -r 25 -i file dstDir+outfile
</code></pre>
<h1 id="output-files">Output files</h1>
<p>In addition to saving video, Trigger Camera also saves a .txt file for each video with frame time stamps.</p>
<p>Here are the first 5 frames of an output .txt file</p>
<pre><code>date,time,seconds,frame
20160520,074319.0,1463744599.61,1
20160520,074319.0,1463744599.65,2
20160520,074319.0,1463744599.68,3
20160520,074319.0,1463744599.71,4
20160520,074319.0,1463744599.74,5
</code></pre>
<p><strong>to do</strong> ADD A HEADER LINE WITH FPS and VIDEO WIDTH/HEIGHT PLUS OTHER PARAMETERS.</p>
<h1 id="analysis">Analysis</h1>
<p>We have provided Python code to load, analyze and plot these output .txt file. See <a href="https://github.com/cudmore/triggercamera/blob/master/analysis/analysis_v1.ipynb">an example iPython notebook</a></p>
<p><IMG SRC="img/analysis_v2.png"></p>
<h1 id="troubleshooting">Troubleshooting</h1>
<ul>
<li>
<p>Test the camera with</p>
<p>raspistill -o tst.jpg</p>
</li>
<li>
<p>If the camera triggering is erratic or the Raspberry is missing fast pulses, check that all digital lines going to the Raspberry Pi are grounded. It is good practice to connect the Raspberry Pi ground pins to the ground (shield) of any digital lines.</p>
</li>
<li>
<p>If the recorded video changes light-levels erratically, this is usllay due to fluctuations in the power to the Pi. Make sure the Pi has a DC power supply &gt;2 Amps. If additional LEDs are being powered by the Pi, consider breaking these out with their own dedicated power supplies.</p>
</li>
<li>
<p>See this to auto mount an SMB share on boot</p>
</li>
</ul>
<p>http://raspberrypi.stackexchange.com/questions/34444/cant-get-a-cifs-network-drive-to-mount-on-boot</p>
<h2 id="to-do">To Do</h2>
<ul>
<li>Implement a Flask homepage to provide buttons to control camera and feedback during a trial.</li>
<li>
<p>Add control and interface for two LEDs (e.g. IR and white).</p>
</li>
<li>
<p>try using easydict so i can use'.' notation in code</p>
</li>
</ul></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="./js/jquery-1.10.2.min.js"></script>
        <script src="./js/bootstrap-3.0.3.min.js"></script>
        <script src="./js/highlight.pack.js"></script>
        <script>var base_url = '.';</script>
        <script data-main="./mkdocs/js/search.js" src="./mkdocs/js/require.js"></script>
        <script src="./js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>

<!--
MkDocs version : 0.15.3
Build Date UTC : 2016-05-20 13:04:19.147144
-->
