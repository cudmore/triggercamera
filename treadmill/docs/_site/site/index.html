<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <meta name="author" content="Robert H Cudmore">  
    <link rel="shortcut icon" href="./favicon.ico">

    <title>treadmill</title>

    <link href="./css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="./css/base.css" rel="stylesheet">
    <link href="./css/cinder.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/highlight.css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
</head>

<body class="homepage" >

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href=".">treadmill</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li class="active">
                        <a href=".">home</a>
                    </li>
                
                
                
                    <li >
                        <a href="images/">images</a>
                    </li>
                
                
                
                    <li >
                        <a href="about/">about</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                
                    <li>
                        <a href="http://github.com/cudmore/treadmill">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="first-level active"><a href="#introduction">Introduction</a></li>
        
            <li class="second-level"><a href="#web-interface">Web Interface</a></li>
            
        
            <li class="second-level"><a href="#arduino-setup">Arduino Setup</a></li>
            
                <li class="third-level"><a href="#hardware">Hardware</a></li>
            
                <li class="third-level"><a href="#wiring-the-arduino">Wiring the arduino</a></li>
            
        
            <li class="second-level"><a href="#upload-code-to-the-arduino">Upload code to the Arduino</a></li>
            
                <li class="third-level"><a href="#required-libraries">Required libraries</a></li>
            
                <li class="third-level"><a href="#upload-using-the-arduino-ide">Upload using the Arduino IDE</a></li>
            
                <li class="third-level"><a href="#upload-using-platformio">Upload using platformio</a></li>
            
                <li class="third-level"><a href="#low-level-interrupts">Low Level Interrupts</a></li>
            
        
            <li class="second-level"><a href="#server-setup">Server Setup</a></li>
            
                <li class="third-level"><a href="#python">Python</a></li>
            
                <li class="third-level"><a href="#install-required-python-libraries">Install required python libraries</a></li>
            
        
            <li class="second-level"><a href="#running-an-experiment">Running an experiment</a></li>
            
                <li class="third-level"><a href="#arduino-interface">Arduino interface</a></li>
            
                <li class="third-level"><a href="#python-interface">Python interface</a></li>
            
                <li class="third-level"><a href="#web-interface_1">Web interface</a></li>
            
                <li class="third-level"><a href="#rolling-your-own-interface">Rolling your own interface</a></li>
            
        
            <li class="second-level"><a href="#links">Links</a></li>
            
        
    
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="_1"></h1>
<h1 id="introduction">Introduction</h1>
<p>Controlling an experiment with an Arduino microcontroller has become commonplace in scientific labs. A major bottle-neck in making experiments controlled with an Arduino main-stream is the difficulty in their use. Once embedded into an experiment, the control of an Arduino often involves cognitively-demanding command line interaction which detracts from potentially complicated experiments. Thus, a simplified interface to control an Arduino during an experiment is necessary.</p>
<p>Here, we present a simplified and experimentally fool-proof web interface to control an Arduino using a point-and-click web interface. In particular, we have built a motorized treadmill for in vivo head-fixed two-photon imaging. We provide schematics for building the treadmill as well as Arduino and Python code to control the treadmill.</p>
<p>This is a general-purpose open-source framework where Arduino based experiments can be controlled through a web interface. The source-code can be easily modified to meet new and unique experimental designs.</p>
<h2 id="web-interface">Web Interface</h2>
<p><IMG SRC="img/screenshot1.png" WIDTH=450 style="border:1px solid gray"></p>
<p>The top section provides an interface to start/stop a trial and plots real-time feedback as the trial is running.</p>
<p>The middle section provides an interface to set stimulus parameters for a trial and to upload these parameters to an Arduino. This section also provides a plot of what the trial will look like based on the set of parameters entered.</p>
<h2 id="arduino-setup">Arduino Setup</h2>
<h3 id="hardware">Hardware</h3>
<ul>
<li>
<p>Arduino Uno</p>
</li>
<li>
<p>Stepper Motor, <a href="https://www.sparkfun.com/products/9238">Sparkfun - 09238</a>, $15</p>
</li>
<li>
<p>Stepper motor driver, EasyDriver, <a href="https://www.sparkfun.com/products/12779">Sparkfun - 12779</a>, $15. Main website for <a href="http://www.schmalzhaus.com/EasyDriver/">EasyDriver</a></p>
</li>
<li>
<p>Rotary encoder, <a href="http://www.digikey.com/product-detail/en/600128CBL/600CS-ND/53504">Honeywell-600-128-CBL</a>, <a href="http://sensing.honeywell.com/600%20series_005940-2-en_final_12sep12.pdf">.pdf</a> spec sheet, $37</p>
</li>
<li>
<p>IR LED, 840-850 nm, <a href="https://www.sparkfun.com/products/9469">Sparkfun - 9469</a> $1 each (960 nm IR LEDs do not work well with Pi Noir camera)</p>
</li>
<li>
<p>Actobotics at <a href="https://www.servocity.com/html/actoboticstm.html">ServoCity</a> and <a href="https://www.sparkfun.com/actobotics">Sparkfun</a>. Give <a href="https://www.servocity.com/html/actoboticstm.html">ServoCity</a> a shot, their visual guides and project ideas are really helpful in desining components. This can be your one stop shop for all structural components including frames, rods, bearings, clamps, and motor mounts.</p>
</li>
</ul>
<h3 id="wiring-the-arduino">Wiring the arduino</h3>
<ul>
<li>Wire the stepper motor</li>
<li>Wire the stepper motor to the stepper motor driver</li>
<li>Wire the rotary encoder</li>
<li>Wire the DIO pins to communicate with ScanImage</li>
</ul>
<h2 id="upload-code-to-the-arduino">Upload code to the Arduino</h2>
<h3 id="required-libraries">Required libraries</h3>
<p>You want to use these non-blocking libraries otherwise your code will not perform well. If you don't use these libraries then code to turn the stepper motor will block other code like reading the rotary encoder. </p>
<ul>
<li>
<p><a href="http://www.airspayce.com/mikem/arduino/AccelStepper/classAccelStepper.html">AccelStepper</a> library to control stepper motor</p>
</li>
<li>
<p>Rotary encoder library from <a href="https://www.pjrc.com/teensy/td_libs_Encoder.html">PJRC</a></p>
</li>
</ul>
<h3 id="upload-using-the-arduino-ide">Upload using the Arduino IDE</h3>
<p>The source code for the Arduino can be found in <a href="https://github.com/cudmore/treadmill/blob/master/arduino/src/treadmill.cpp">/arduino/src/treadmill.cpp</a>.</p>
<p>Use the standard Arduino IDE to upload treadmill.cpp to your Arduino. Make sure you have the required Arduino libraries installed. Also be sure you understand how to activate addition <a href=".#lowlevelinterrupts">low level interrupts</a> if using an Arduino Uno.</p>
<h3 id="upload-using-platformio">Upload using platformio</h3>
<p>If you prefer you can use <a href="http://platformio.org/">Platformio</a> to do everything from a command line. This has the distinct advantage that you can compile and upload code from a headless computer including a Raspberry Pi or any system running Linux.</p>
<p>Platformio is a python library so you should be good to go with <code>pip install platformio</code>. </p>
<p>Have a look <a href="http://docs.platformio.org/en/latest/quickstart.html#initialize-project">here</a> to create a platformio.ini file for your specific Arduino. Here are three different board configurations</p>
<pre><code>platformio init --board uno # arduino uno
platformio init --board pro16MHzatmega328 # generic arduino pro 
platformio init --board nodemcuv2 # arduino node mcu
</code></pre>

<p>After 'platformio init', platformio.ini will have environment configurations. You only want to have one of these blocks at a time to simplify compilation. For example [env:uno].</p>
<pre><code>[env:uno]
platform = atmelavr
framework = arduino
board = uno
build_flags = -D _expose_interrupts_ #creates compiler directive

[env:pro16MHzatmega328]
platform = atmelavr
framework = arduino
board = pro16MHzatmega328

[env:nodemcuv2]
platform = espressif
framework = arduino
board = nodemcuv2
upload_port = /dev/ttyUSB0

</code></pre>

<p>Compile, upload, and clean Arduino code with</p>
<pre><code>platformio run #compile arduino code
platformio run --target upload #compile and upload
platformio run --target clean #clean project 
</code></pre>

<p>Finally, once the code is running you can open a serial port connection with</p>
<pre><code>platformio serialports monitor -p /dev/ttyUSB0 -b 115200 #a serial port monitor
</code></pre>

<p>Specifying the correct serial port for the Arduino is critical. Specify this in the treadmill.py file.</p>
<pre><code>#serialStr = '/dev/tty.usbmodem618661' #teensy at work
#serialStr = '/dev/tty.usbmodem618661' #teensy?
#serialStr = '/dev/ttyUSB0' #hand soldered arduino micro (home debian)
#serialStr = '/dev/tty.usbserial-A50285BI' # hand soldered at work
serialStr = '/dev/ttyACM0' #uno
</code></pre>

<p><a name="lowlevelinterrupts"></a></p>
<h3 id="low-level-interrupts">Low Level Interrupts</h3>
<p>The Uno only comes with two pins (2 and 3) capable of low-level interrupts and more pins need to be broken out. We need two low level interrupts for the Rotary Encoder and a few more to quickly intercept TTL pulses of the FrameClock.</p>
<p>See <a href="http://www.geertlangereis.nl/Electronics/Pin_Change_Interrupts/PinChange_en.html">Pin-change interrupts</a> for information on exposing additional pins as low-level interrupts.</p>
<p>We have included a compiler directive <code>_expose_interrupts_</code> in treadmill.cpp that if activated will run code to expose additional interrupts. </p>
<ul>
<li>If using platformio this is taken care of in the [env] section of platformio.ini</li>
<li>If using the arduino IDE, <code>define _expose_interrupts_ = 1</code> must be included in <a href="https://github.com/cudmore/treadmill/blob/master/arduino/src/treadmill.cpp">treadmill.cpp</a></li>
</ul>
<pre><code>//Uncomment this line if running on an Arduino Uno and compiling with the arduino IDE
//#define _expose_interrupts_ 1
</code></pre>

<h2 id="server-setup">Server Setup</h2>
<h3 id="python">Python</h3>
<p>Download and install <a href="https://www.continuum.io/why-anaconda">Anaconda</a>. Anaconda is a <a href="http://www.python.org/">python</a> installation that will install many commonly used libraries. It is much easier to get started with Anaconda rather than a basic installation of Python.</p>
<h3 id="install-required-python-libraries">Install required python libraries</h3>
<p>Install additional required python libraries using the included requirements.txt file</p>
<p><code>pip install -r requirements.txt</code></p>
<p>Here is the requirements.txt file</p>
<pre><code>eventlet&gt;=0.18.4
Flask&gt;=0.10.1
Flask-Markdown&gt;=0.3
Flask-SocketIO&gt;=1.0
platformio&gt;=2.8.5
plotly&gt;=1.9.6
pyserial&gt;=3.0.1
</code></pre>

<h2 id="running-an-experiment">Running an experiment</h2>
<p>At its core, an experiment is run on the Arduino using <a href="https://github.com/cudmore/treadmill/blob/master/arduino/src/treadmill.cpp">treadmill.cpp</a>. We have provided two additional interfaces: a python interface and a web based interface.</p>
<h3 id="arduino-interface">Arduino interface</h3>
<p>The Arduino program <a href="https://github.com/cudmore/treadmill/blob/master/arduino/src/treadmill.cpp">treadmill.cpp</a> provides a simple serial interface to get and set parameters of a trial and to start and stop a trial. Once the program is uploaded to an Arduino, open your favorite serial port and start entering commands.</p>
<pre><code>startTrial # start a trial
stopTrial # stop a trial
getState # 
settrial,[name],[value]
</code></pre>

<p><code>settrial</code> takes the <code>name</code> and <code>value</code> of a trial parameter to set. The <code>name</code> needs to be one of: numPulse, numEpoch, epochDur, preDur, etc. These names match the 'Stimulus' parameters provided in the web interface. See the SetTrial() function in <a href="https://github.com/cudmore/treadmill/blob/master/arduino/src/treadmill.cpp">treadmill.cpp</a> for all possible trial parameters.</p>
<p>Entering <code>getState</code> in a serial window and the Arduino will return the current values for all trial parameters. This is also a good way to find the names of trial parameters and then set them like <code>settrial,epochDur,5000</code>.</p>
<pre><code>=== Arduino State ===
trialNumber=0
trialDur=1000
numEpoch=1
epochDur=1000
preDur=1000
postDur=1000
numPulse=3
pulseDur=1000
useMotor=1
motorDel=200
motorDur=200
motorSpeed=0
motorMaxSpeed=0
versionStr=20160322
=== Done ===
</code></pre>

<h3 id="python-interface">Python interface</h3>
<p>You can  use iPython or any Python command interpreter to drive an experiment. You can also write your own python code to interface with the core python code in <a href="https://github.com/cudmore/treadmill/blob/master/treadmill.py">treadmill.py</a>.</p>
<p>Here is a short example of running an experiment in Python</p>
<pre><code class="python">import treadmill
t = treadmill.treadmill() # create a treadmill object
t.startTrial() # start a new trial
t.stopTrial() # stop a trial
t.GetArduinoState() # get the current state with all trial parameters (see Arduino getstate below).
t.settrial('epochDur',5000) # set the value of 'epochDur' trial parameter to 5000 ms
t.startTrial() # start a new trial
</code></pre>

<p>The python interface and arduino interface share all trial parameter names.</p>
<h3 id="web-interface_1">Web interface</h3>
<p>A web interface is provided as a <a href="http://flask.pocoo.org">Flask</a> server in <a href="https://github.com/cudmore/treadmill/blob/master/treadmill_app.py">treadmill_app.py</a>. Flask is a micro-framework that allows a web-server to be created and controlled all from within python.</p>
<p>Run the web interface with <code>python treadmill_app.py</code>. This will run a web server at <code>http://192.168.1.200:5000</code>. You can change the default address and port in <a href="https://github.com/cudmore/treadmill/blob/master/treadmill_app.py">treadmill_app.py</a></p>
<pre><code>#this will run Flask on the machines local ip (use this if on a lan)
socketio.run(app, host='0.0.0.0', port=5010, use_reloader=True)
#this will run this on localhost, use this if using a single machine (no LAN needed)
socketio.run(app, host='', port=5010, use_reloader=True)
</code></pre>

<h3 id="rolling-your-own-interface">Rolling your own interface</h3>
<p>You can roll your own interface by interfacing directly with the Arduino code in <a href="https://github.com/cudmore/treadmill/blob/master/arduino/src/treadmill.cpp">treadmill.cpp</a>, the python code in <a href="https://github.com/cudmore/treadmill/blob/master/treadmill.py">treadmill.py</a>, or the Flask server code in <a href="https://github.com/cudmore/treadmill/blob/master/treadmill_app.py">treadmill_app.py</a>.</p>
<h2 id="links">Links</h2>
<p>Flask</p>
<ul>
<li>
<p><a href="https://flask-socketio.readthedocs.org/en/latest/">flask-socketio</a></p>
</li>
<li>
<p><a href="https://pythonhosted.org/Flask-Markdown/">flask-markdown</a></p>
</li>
<li>
<p><a href="http://eventlet.net/">eventlet</a></p>
</li>
</ul>
<p>Arduino</p>
<ul>
<li>
<p><a href="http://platformio.org/">platormio</a></p>
</li>
<li>
<p><a href="http://docs.platformio.org/en/latest/userguide/cmd_serialports.html#platformio-serialports-monitor">platform io serial port monitor</a></p>
</li>
<li>
<p><a href="http://www.airspayce.com/mikem/arduino/AccelStepper/classAccelStepper.html">AccelStepper</a></p>
</li>
<li>
<p><a href="https://www.pjrc.com/teensy/td_libs_Encoder.html">Rotary Encoder</a></p>
</li>
</ul></div>
        
    </div>

    <footer class="col-md-12 text-center">
        <hr>
        <p>
        <small>Treadmill was created by Robert H Cudmore and is licensed under the <a href='https://github.com/cudmore/treadmill/blob/master/LICENSE'>MIT license</a><br></small>
        
        <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>
    </footer>

    <script src="./js/jquery-1.10.2.min.js"></script>
    <script src="./js/bootstrap-3.0.3.min.js"></script>
    <script src="./js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '.';
    </script>
    <script data-main="./mkdocs/js/search.js" src="./mkdocs/js/require.js"></script>
    <script src="./js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>

<!--
MkDocs version : 0.15.3
Build Date UTC : 2016-04-27 13:39:53.993971
-->
